{% extends "layout.html" %}
{% import "macros.html" as macros %}

{% block content %}

{{ macros.displayBreadcrumbs(breadcrumbs) }}

<h1 class="govuk-heading-xl">{{ team['name'] }}</h1>

<details class="govuk-details">
    <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      About {{ team['name'] }}
    </span>
    </summary>
    <div class="govuk-details__text">
        {{ team['details'] }}
    </div>
</details>

{% if metrics|length > 0 %}
<table class="govuk-table">
    <thead class="govuk-table__head">
    <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="col">
            {% if team['has_subteams'] == 'true' %}
                Aggregated
            {% endif %}
            Metrics
        </th>
        {% for metric in metrics %}
        <th class="govuk-table__header" scope="col">Q3 2018-19: {{ metric.started_on[:10] }} - {{ metric.ended_on[:10] }}</th>
        {% endfor %}
    </tr>
    </thead>
    <tbody class="govuk-table__body">
    <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="row">Cycle Time<br>(source: {{ metrics[0].source }})</th>
        {% for metric in metrics %}
        <td class="govuk-table__cell">{{ metric.avg_cycle_time }}</td>
        {% endfor %}
    </tr>
    <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="row">Process Cycle Efficiency<br>(source: {{ metrics[0].source }})</th>
        {% for metric in metrics %}
        <td class="govuk-table__cell">
            {% if metric.process_cycle_efficiency is string %}
                {{ metric.process_cycle_efficiency }}
            {% else %}
                {{ '%0.2f' % (metric.process_cycle_efficiency * 100)  }}
            {% endif %}
        </td>
        {% endfor %}
    </tr>
    <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="row">Number Of Stories Completed<br>(source: {{ metrics[0].source }})</th>
        {% for metric in metrics %}
        <td class="govuk-table__cell">{{ metric.num_completed }}</td>
        {% endfor %}
    </tr>
    <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="row">Number Of Stories Incomplete<br>(source: {{ metrics[0].source }})</th>
        {% for metric in metrics %}
        <td class="govuk-table__cell">{{ metric.num_incomplete }}</td>
        {% endfor %}
    </tr>
    {% if git_metrics %}
    <tr class="govuk-table__row" style='vertical-align: top'>
        <th class="govuk-table__header" scope="row">Code rework <span style='font-weight: normal'>(average)</span><br>(source: github)<div style='font-weight: normal; text-align: right'>rework% (#PRs)<br>#comments</div></th>
        {% for metric in metrics %}
        <td class="govuk-table__cell">
            <div>{{ '%0.2f' % (metric.code_rework) }}%</div>
        </td>
        {% endfor %}
    </tr>
        {% for metric in git_metrics %}
    <tr class="govuk-table__row">
        <th class="govuk-table__header" style="text-align: right; font-weight:normal;" scope="row">
            {{ metric.name }}
        </th>
            {% for sprint_metric in metric.sprints %}
        <td class="govuk-table__cell">
                {% if sprint_metric['code_rework'] == "-" %}
            _
                {% else %}
            <a target='_github' href="{{ sprint_metric.url }}">
                    {{ '%0.2f' % (sprint_metric['code_rework']) }}% ({{ sprint_metric['num_prs'] }})
            </a><br>
                {{ sprint_metric['total_comments'] }}
                {% endif %}
        </td>
            {% endfor %}
    </tr>
        {% endfor %}
    <tr>
        <td colspan="{{metrics|length + 1}}">
            <canvas id="myChart"></canvas>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
            <script lang="javascript">
                var ctx = document.getElementById('myChart').getContext('2d');
                var chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'bar',
                
                    // The data for our dataset
                    data: {
                        labels: [{% for metric in metrics %}"{{ metric.started_on[:10] }} - {{ metric.ended_on[:10] }}",{% endfor %}],
                        datasets: [
                            {
                                label: "Observe code rework",
                                backgroundColor: 'rgb(200, 200, 200)',
                                borderColor: 'rgb(100, 100, 100)',
                                data: [{% for metric in metrics %}{{ metric.code_rework }}, {% endfor %}],
                            },
                            {% set counter = 0 %}
                            {% for metric in git_metrics %}
                            {
                                label: "{{ metric.name }}",
                                backgroundColor: 'rgb({{ 50 + loop.index * 20 }}, {{ 50 + loop.index * 30 }}, {{ 50 + loop.index * 30 }})',
                                borderColor: 'rgb(100, {{ 100 + loop.index * 10 }}, {{ 150 + loop.index * 10 }})',
                                data: [{% for sprint_metric in metric.sprints %}{% if sprint_metric.code_rework == '-' %}0{% else %}{{ '%0.2f' % (sprint_metric.code_rework) }}{% endif %}, {% endfor %}],
                            },
                            {% set counter = counter + git_metrics|length %}
                            {% endfor %}
                        ]
                    },
                
                    // Configuration options go here
                    options: {}
                });
            </script>
        </td>
    </tr>
    {% endif %}
    </tbody>
</table>
{% endif %}

{{ macros.listSubteams(team, subteams) }}

{% endblock %}
